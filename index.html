<!DOCTYPE html>
<html>
    <head>
        <link rel = stylesheet href="format.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>    
        <script src="d3.v7.js"></script>
        <title>Start Page</title>
        <script>
            // soil mdl columns and replacment values
            const soil_mdls = [10, 50, 0.32, 0.11, 3.3, 0.95, 0.91, 0.97, 0.2, 0.4, 1.0]
            const soil_cols = ['TP', 'TN', 'm3.P', 'm3.Fe', 'm3.Al', 'm3.Ca', 'm3.Mg', 'm3.K', 'wEX.P', 'wEX.NH3', 'wEX.NOx']
            
            // water mdl columns and replacment values
            const wtr_mdls = [0.01, 0.02, 0.05, 0.015, 0.075]
            const wtr_cols = ['disPO4', 'disNH4', 'disNO3','TP', 'TN']

            // map coordinates and standard zoom
            const coor_map = {lat:41.024108551696095, long: -83.68860776599949, zoom:15, zoomin:19, r:10}
            const wind = {width : window.innerWidth/2 - 50, height : window.innerHeight/2, margin : 30}

            const seq_col = ["#f7f7f7", "#cccccc", "#969696", "#636363", "#252525"]

        </script>
    </head>

<body>
    <div id = "title"></div>
    <div id = "top"></div>
    <div id = "mid">
        <div id = "map"></div>
        <div id = graph class = "graph"></div>
    </div>
    <p></p>
    <div id = "foot"></div>
  
    <script type = "module">
        let water = await d3.csv("Midden_Oakwoods_Data_Water.csv"); 
        let soil = await d3.csv("Midden_Oakwoods_Data_Soil.csv"); 
        let images = ["ColdWater", "ParkDistrict", "Provider"];

        let cvs_files = {"water": {"data": water, "mdl_cols":wtr_cols, "mdl_vals": wtr_mdls},
                        "soil":{"data": soil, "mdl_cols":soil_cols, "mdl_vals": soil_mdls}}

        let cvs_names = ['water', 'soil']
        let defualt = "water"
        let selected = defualt
        let data = cvs_files[selected].data
        let current_chem = 'TN'

        //Header --------------------------------------------------------------------------------------------------------------------
        let imgs = d3.select('#title')
                      .append('header')
                      .text("Oakwoods Nature Preserve Water Restoration Project")

        // Add Footer Images --------------------------------------------------------------------------------------------------------
        imgs.select('#foot')
              .append('footer')
              .append('nav')
              .data(images)
              .join('img')
              .attr('class', 'imgs')
              .attr('src', (d) => "Images/" + d + ".png")
              .attr('alt', (d) => d)

        // Add navigation buttons ----------------------------------------------------------------------------------------------------
        let navbar = d3.select("#top");
        navbar.append('nav')
              .attr('class', 'navbar')
              .append('ul')
                .attr('class', 'navbar')
        
        let nav_btns = navbar.selectAll('ul')
                             .append('li')
                                .attr('class', 'navbar')                  
        
        let nav_label = nav_btns.append("label")
                .attr("for", "map_select")
                .attr("font-size", 16)
                .text("Sample Media ")
        
        let map_drop = nav_btns.append("select")
                .attr("id", `map_select`)
                .attr("name", 'map_select')
        
      
         // add options to map seletion dropdown --------------------------------------------------------------------------------------
         var nav_drp = map_drop.selectAll()
                            .data(cvs_names)
                            .join(
                                enter => enter.append('option')
                            .text(d => d)
                            .attr("value", (d) => d)
                        )
        

        let loc_label = nav_btns.append("label")
                .attr("for", "loc_select")
                .attr("font-size", 16)
                .text("Sample Location: ")
        
        let loc_drop = nav_btns.append("select")
                .attr("id", `loc_select`)
                .attr("name", 'loc_select')

        let loc_names = d3.groups(data, (d) => d.locName)

        // add location options to dropdown ------------------------------------------------------------------------------------
        loc_drop.append('option').text('All Locations').attr("value", true)
        var nav_drp = loc_drop.selectAll()
                            .data(loc_names)
                            .join(
                                enter => enter.append('option')
                            .text(d => d[0] )
                            .attr("value", (d) => d[0])
                        )
 // ---------------------------------------------------------------------------------------------------------------------------------
        let chem_label = nav_btns.append("label")
                .attr("for", "chem_select")
                .attr("font-size", 16)
                .text("Chemical: ")
        
        let chem_drop = nav_btns.append("select")
                .attr("id", `chem_select`)
                .attr("name", 'chem_select')

        let chem_names = cvs_files[selected].mdl_cols

        // add location options to dropdown ------------------------------------------------------------------------------------
        var chem_drp = chem_drop.selectAll()
                            .data(chem_names)
                            .join(
                                enter => enter.append('option')
                            .text((d, i) => chem_names[chem_names.length - i - 1] )
                            .attr("value",(d, i) => chem_names[chem_names.length - i - 1] )    
                            )   
        // Add Copy Right -----------------------------------------------------------------------------------------------------------
        let attribution = navbar.selectAll('ul')
                            .append('li')
                                .attr('class', 'copyright')
                            .append('a')
                                .attr('href', "http://www.openstreetmap.org/copyright")
                                .text("openstreetmap copyright")

        // Add Simple graphs -------------------------------------------------------------------------------------------------------
        const graphic = d3.select('#graph')
        const graph_sec = graphic.append('div')
                  .attr('class', 'graph')
        
        var svg = graph_sec
                        .append('svg')
                        .attr('width', wind.width + wind.margin)
                        .attr('height', wind.height + wind.margin)

        // find date
        // inputs: data
        // returns: converts visit date into date objects
        //============================================================================================================================
        function format_date(data){
            for(var i = 0; i < data.length; i++){
                let date = data[i].visitDate.substring(0,4) + "-" 
                         + data[i].visitDate.substring(4, 6) + "-" 
                         + data[i].visitDate.substring(6,8)
                    data[i].visitDate =  new Date(date)
            }
        }

         // convert_col
        // inputs: data, column
        // returns: nothing converts all numbers in a column from string to number format
        //=============================================================================================================================
        function convert_col(data, column){
            let numbers = []
            for(var i = 0; i < data.length; i++){
                let element = data[i][column];
                data[i][column] = Number(element)
            }
        }

        
        // remove_MDLs
        // inputs: data, mdls, column
        // returns: nothing converts strings '<MDL' into mdl values
        //=============================================================================================================================
       function remove_MDLs(data, mdls, columns){
            for(var i = 0; i < data.length; i++){
                for(var j = 0; j < mdls.length; j++){
                    if(data[i][columns[j]] != null){
                            if(data[i][columns[j]] == "<MDL"){
                                data[i][columns[j]] = mdls[j]
                        }
                    data[i][columns[j]] = Number(data[i][columns[j]])
                    }
                    
                }
            }
        }

        // clean_data
        // inputs: data, column
        // returns: cleans data files and puts everything in proper format
        //=============================================================================================================================
       function clean_data(){
            for(var i = 0; i < cvs_names.length; i++){
                let file_data = cvs_names[i]
                format_date(cvs_files[file_data].data)
                remove_MDLs(cvs_files[file_data].data, cvs_files[file_data].mdl_vals, cvs_files[file_data].mdl_cols)
            }
        }

        // build graph
        // inputs: data
        // returns: Adds a interactive graph to the website given in put data
        //=============================================================================================================================
        /*
            convert_col(data, current_chem)
            
            // get latest and recent dates
            let min_date = d3.min(data, (d)=> d.visitDate)
            let max_date = d3.max(data, (d)=> d.visitDate)

            // get smallest and largest cham value
            let min_chem = d3.min(data, d => d[current_chem])
            let max_chem = d3.max(data, d => d[current_chem])
            

            // remove empty cham values
            data = d3.filter(data, (d) => d[current_chem])

            // create x and y axis elements
            let x = d3.scaleTime()
                        .domain([min_date, max_date])
                        .range([wind.margin, wind.width - wind.margin])
            
            let y = d3.scaleLinear()
                    .domain([min_chem, max_chem])
                    .range([wind.height - wind.margin, wind.margin])
            
            // add x and y axis to website div
            let gx = svg.append("g")
                .attr("transform", `translate(${wind.margin}, ${wind.height - wind.margin})`)
                .call(d3.axisBottom(x))

            let gy = svg.append("g")
                .attr("transform", `translate(${wind.margin}, 0)`)
                .call(d3.axisLeft(y))
            
            // create and add dots to graph
            
            let dots = svg.append('g')
                .selectAll('circle')
                .data(data)
                .join('circle')
                    .attr('cy', (d) =>  {return y(d[current_chem])})
                    .attr('cx', (d) => { return wind.margin + x(d['visitDate'])})
                    .attr('r', 2)
                    .attr('fill', 'teal')

        */

        // Add X axis
        var x = d3.scaleTime()
          .range([ 0, wind.width ]);

        var xAxis = svg.append("g")
          .attr("transform", "translate(0," + wind.height + ")")

        // Add Y axis
        var y = d3.scaleLinear()
          .range([ wind.height, 0]);

        var yAxis = svg.append("g")
          .attr("class", "myYaxis")

        // Add the line
        var line = svg.append("path")
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 1.5)

        // update_data
        // inputs: data
        // returns: updates graph given interactive
        //=============================================================================================================================
        // Dropdown change event
        function update_chart(data, chem) {
            // Create a update selection: bind to the new data
            var update = line
              .datum(data)

            // Update the X axis
            //x.domain(d3.extent(data, function(d) { return d3.timeParse("%Y%m%d")(d.visitDate); }))
            //xAxis.call(d3.axisBottom(x));

            // Update the Y axis
            y.domain([0, d3.max(data, function(d) { return +d.chem; })]);
            yAxis.transition().duration(1000).call(d3.axisLeft(y));

            // Update the line
           /* update
              .transition()
              .duration(1000)
              .attr("d", d3.line()
                .x(function(d) { return x(d3.timeParse("%Y%m%d")(d.date)); })
                .y(function(d) { return y(+d.TP); })
              )*/
        }
        
        // Initialize the plot with the first dataset
        update_chart(data)

           /* function update_graph(data){
                // update recent and latest dates
                min_date = d3.min(data, (d)=> d.visitDate)
                max_date = d3.max(data, (d)=> d.visitDate)
                   
                // update smallest and largest value
                let min = d3.min(data, d => d[current_chem])
                let max = d3.max(data, d => d[current_chem])
                 
                data = d3.filter(data, (d) => d[current_chem] != '')


                // rebuild x axis
                x = d3.scaleTime()
                        .domain([min_date, max_date])
                        .range([wind.margin, wind.width - wind.margin])

                // convert original axis to new x axis
                gx.transition()
                        .duration(500)
                        .attr("transform", `translate(${wind.margin}, ${wind.height - wind.margin})`)
                        .call(d3.axisBottom(x))

                // rebuild y axis
                y = d3.scaleLinear()
                    .domain([min, max])
                    .range([wind.height - wind.margin, wind.margin])

                // convert original y axis to new y axis
                gy.transition()
                        .duration(500)
                        .attr("transform", `translate(${wind.margin}, 0)`)
                        .call(d3.axisLeft(y))


                dots.selectAll('circle').transition()
                
            }
            */

        
       //Add Graph ----------------------------------------------------------------------------------------------------------------
        clean_data();

//=====================================================================================================================================
 //Add Map ----------------------------------------------------------------------------------------------------------------
//====================================================================================================================================
        // calc _clr
        // inputs: data, chem, r
        // returns: calculates the color of circle based on chemical average
        //=============================================================================================================================
        function calc_clr(data, chem = "TP", r){
            let mark_color =  seq_col[0]
            for(var j = 0; j < seq_col.length; j++){
                    let quant =  d3.quantile(data, j/(seq_col.length-1), d => d[chem])

                    if(r >= quant){
                        mark_color = seq_col[j]
                    }
                    else{
                        return mark_color
                    }
                }
        }
        // get_markloc
        // inputs: data, chem
        // returns: returns an array of markers with location coordinates
        //=============================================================================================================================
        function get_markloc(data, chem = "TP"){
            let lat_long = []
            let loc_groups = d3.groups(data, d => d.locName)

            for(var i = 0; i < loc_groups.length; i++){
                let str_data = loc_groups[i][0]
                let x = d3.median(loc_groups[i][1], d=> d.x)
                let y = d3.median(loc_groups[i][1], d=> d.y)

                let color = d3.mean(loc_groups[i][1], d => d[chem])
                let max_val = d3.max(loc_groups[i][1], d => d[chem])
                let r = (color/max_val) * coor_map.r 

                let mark_color = calc_clr(data, chem, color)
                lat_long.push(L.circleMarker([y, x], {radius:r, color:mark_color}).bindPopup(str_data))
                lat_long.push(L.marker([y, x], {color:mark_color}).bindPopup(str_data))
                
             }
             return lat_long
        }

        var map = L.map('map').setView([ coor_map.lat, coor_map.long], coor_map.zoom);

        let markers = []
        markers = get_markloc(data, current_chem)
        

        let mark_group = L.layerGroup(markers)
        mark_group.addTo(map);

        // get selection for map
        d3.select("#map_select")
                .on('change', function(event, d){
                    // get option selected
                    map.removeLayer(mark_group)
                    let lat = coor_map.lat
                    let long = coor_map.long
                    let zoom = coor_map.zoom
                    selected = d3.select(this).property("value")

                    data = cvs_files[selected].data 
                    data = d3.filter(data, (d) => d.x != '#N/A' && d.y != '#N/A')

                    markers = get_markloc(data, current_chem)
                    
                    map.setView([lat, long], zoom)
                    mark_group = L.layerGroup(markers)
                    mark_group.addTo(map);

                    //update_graph(data)

            })

            d3.select('#chem_select')
                .on('change', function(event, d){
                    selected = d3.select(this).property("value")
                    current_chem = selected
                    map.removeLayer(mark_group)
                    let lat = coor_map.lat
                    let long = coor_map.long
                    let zoom = coor_map.zoom
                    
                    data = d3.filter(data, (d) => d.x != '#N/A' && d.y != '#N/A')
                    markers = get_markloc(data, current_chem)

                    map.setView([lat, long], zoom)
                    mark_group = L.layerGroup(markers)
                    mark_group.addTo(map);

                    //update_graph(data)

                })

            // add markers for location filter
            d3.select("#loc_select")
                .on('change', function(event, d){
                    // get option selected
                    map.removeLayer(mark_group)
                    selected = d3.select(this).property("value")
                    let filt_data = data
                    let lat = coor_map.lat
                    let long = coor_map.long
                    let zoom = coor_map.zoom
                    markers = []
                    if(selected == "true"){
                         markers = get_markloc(filt_data, current_chem)

                    }
                    else
                    {
                         filt_data = d3.filter(data, d => d.locName == selected)
                         filt_data = d3.filter(filt_data, (d) => d.x != '#N/A' && d.y != '#N/A')
                         long = d3.median(filt_data, (d) => d.x)
                         lat = d3.median(filt_data, (d) => d.y)
                         zoom = coor_map.zoomin

                         for(var i = 0; i < filt_data.length; i++){
                            let str_data = filt_data[i].locName + "\n"  + data[i].notes
                            let colr = calc_clr(data, current_chem, data[i][current_chem])

                            markers.push(L.circle([filt_data[i].y, filt_data[i].x], 
                                        {radius:coor_map.r, color:colr}).bindPopup(str_data))

                            markers.push(L.marker([filt_data[i].y, filt_data[i].x]).bindPopup(str_data))
                         }
                    }
                    map.setView([lat, long], zoom)
                    mark_group = L.layerGroup(markers)
                    mark_group.addTo(map).on('click', onclick);

                    //update_chart(selectedOption)
            })

        
        
        function onclick(e){  
            map.setView([e.latlng.lat, e.latlng.lng], coor_map.zoomin)
        }
        map.on('click', onclick);

        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            maxZoom: 20,
            minZoom: 15,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            layers: [mark_group]
        }).addTo(map);

        
        graph.append(svg.node())

        

     </script>
</body>
</html>