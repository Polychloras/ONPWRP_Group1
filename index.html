<!DOCTYPE html>
<html>
    <head>
        <link rel = stylesheet href="format.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>    
        <script src="d3.v7.js"></script>
        <title>Start Page</title>
        <script>
            const soil_mdls = [10, 50, 0.32, 0.11, 3.3, 0.95, 0.91, 0.97, 0.2, 0.4, 1.0]
            const soil_cols = ['TP', 'TN', 'm3.P', 'm3.Fe', 'm3.Al', 'm3.Ca', 'm3.Mg', 'm3.K', 'wEX.P', 'wEX.NH3', 'wEX.NOx']
            
            const wtr_mdls = [0.01, 0.02, 0.05, 0.015, 0.075]
            const wtr_cols = ['disPO4', 'disNH4', 'disNO3','TP', 'TN']

            const wind = {width : window.innerWidth/2 - 50, height : window.innerHeight/2, margin : 30}

        </script>
    </head>

<body>
    <div id = "title"></div>
    <div id = "top"></div>
    <div id = "mid">
        <div id = "map"></div>
        <div id = graph class = "graph"></div>
    </div>
    <p></p>
    <div id = "foot"></div>
  
    <script type = "module">
        let water = await d3.csv("Midden_Oakwoods_Data_Water.csv"); 
        let soil = await d3.csv("Midden_Oakwoods_Data_Soil.csv"); 
        let images = ["ColdWater", "ParkDistrict", "Provider"];

        let cvs_files = {"water": {"data": water, "mdl_cols":wtr_cols, "mdl_vals": wtr_mdls},
                        "soil":{"data": soil, "mdl_cols":soil_cols, "mdl_vals": soil_mdls}}
        let cvs_names = ['water', 'soil']
        let defualt = "water"
        let selected = defualt
        let data = cvs_files[defualt].data

        //Header --------------------------------------------------------------------------------------------------------------------
        let imgs = d3.select('#title')
                      .append('header')
                      .text("Oakwoods Nature Preserve Water Restoration Project")

        // Add Footer Images --------------------------------------------------------------------------------------------------------
        imgs.select('#foot')
              .append('footer')
              .append('nav')
              .data(images)
              .join('img')
              .attr('class', 'imgs')
              .attr('src', (d) => "Images/" + d + ".png")
              .attr('alt', (d) => d)

        // Add navigation buttons ----------------------------------------------------------------------------------------------------
        let navbar = d3.select("#top");
        navbar.append('nav')
              .attr('class', 'navbar')
              .append('ul')
                .attr('class', 'navbar')
        
        let nav_btns = navbar.selectAll('ul')
                             .append('li')
                                .attr('class', 'navbar')                  
        
        let nav_label = nav_btns.append("label")
                .attr("for", "map_select")
                .attr("font-size", 16)
                .text("Sample Media ")
        
        let map_drop = nav_btns.append("select")
                .attr("id", `map_select`)
                .attr("name", 'map_select')
        
      
         // add options to map seletion dropdown
         var nav_drp = map_drop.selectAll()
                            .data(cvs_names)
                            .join(
                                enter => enter.append('option')
                            .text(d => d)
                            .attr("value", (d) => d)
                        )
        

        let loc_label = nav_btns.append("label")
                .attr("for", "loc_select")
                .attr("font-size", 16)
                .text("Sample Location: ")
        
        let loc_drop = nav_btns.append("select")
                .attr("id", `loc_select`)
                .attr("name", 'loc_select')

        let loc_names = d3.groups(data, (d) => d.locName)
        // add options to map seletion dropdown

        loc_drop.append('option').text('All Locations').attr("value", data)
        var nav_drp = loc_drop.selectAll()
                            .data(loc_names)
                            .join(
                                enter => enter.append('option')
                            .text(d => d[0] )
                            .attr("value", (d) => d[0])
                        )
        
        // Add Copy Right
        let attribution = navbar.selectAll('ul')
                            .append('li')
                                .attr('class', 'copyright')
                            .append('a')
                                .attr('href', "http://www.openstreetmap.org/copyright")
                                .text("openstreetmap copyright")

        // Add Simple graphs -------------------------------------------------------------------------------------------------------
        const graphic = d3.select('#graph')
        const graph_sec = graphic.append('div')
                  .attr('class', 'graph')
        
        var svg = graph_sec
                        .append('svg')
                        .attr('width', wind.width + wind.margin)
                        .attr('height', wind.height + wind.margin)

        // find date
        // inputs: data
        // returns: an array that holds three array containing all the year, months and days
        function format_date(data){
            for(var i = 0; i < data.length; i++){
                let date = data[i].visitDate.substring(0,4) + "-" 
                         + data[i].visitDate.substring(4, 6) + "-" 
                         + data[i].visitDate.substring(6,8)
                    data[i].visitDate =  new Date(date)
            }
        }


        function find_col(data, column){
            let numbers = []
            for(var i = 0; i < data.length; i++){
                let element = data[i][column];
                numbers.push(Number(element))
             
            }
            return numbers
        }

        function remove_MDLs(data, mdls, columns){
            for(var i = 0; i < data.length; i++){
                for(var j = 0; j < mdls.length; j++){
                    if(data[i][columns[j]] != null){
                        data[i][columns[j]] = data[i][columns[j]].replaceAll(" ", "")
                        if(data[i][columns[j]] == "<MDL"){
                        data[i][columns[j]] = mdls[j]
                    }
                    data[i][columns[j]] = Number(data[i][columns[j]])
                    }
                    
                }
            }
        }

        function clean_data(){
            for(var i = 0; i < cvs_names.length; i++){
                let file_data = cvs_names[i]
                format_date(cvs_files[file_data].data)
                remove_MDLs(cvs_files[file_data].data, cvs_files[file_data].mdl_vals, cvs_files[file_data].mdl_cols)
            }
        }

        //Add Map ----------------------------------------------------------------------------------------------------------------
        clean_data();
        build_graph(cvs_files[selected].data)


        function build_graph(data){
            let n4 = find_col(data, 'TN')

            let min_date = d3.min(data, (d)=> d.visitDate)
            let max_date = d3.max(data, (d)=> d.visitDate)

            let min = d3.min(n4)
            let max = d3.max(n4)

            data = d3.filter(data, (d) => d['TN'] != '')
            console.log(data.columns)

            let x = d3.scaleTime()
                        .domain([min_date, max_date])
                        .range([wind.margin, wind.width - wind.margin])
            
            let y = d3.scaleLinear()
                    .domain([min, max])
                    .range([wind.height - wind.margin, wind.margin])
            
            let gx = svg.append("g")
                .attr("transform", `translate(${wind.margin}, ${wind.height - wind.margin})`)
                .call(d3.axisBottom(x))

            let gy = svg.append("g")
                .attr("transform", `translate(${wind.margin}, 0)`)
                .call(d3.axisLeft(y))
            
            let dots = svg.append('g')
                .selectAll('circle')
                .data(water)
                .join('circle')
                    .attr('cy', (d, i) => {( d['TN']); return y(d['TN'])})
                    .attr('cx', (d) => {return wind.margin + x(d['visitDate'])})
                    .attr('r', 2)
                    .attr('fill', 'teal')


            function update_graph(data){
                console.log(data) 
                let n4 = find_col(data, 'TN')

                min_date = d3.min(data, (d)=> d.visitDate)
                max_date = d3.max(data, (d)=> d.visitDate)

                console.log(min_date)
                console.log(max_date)
                console.log(data[0])

                let min = d3.min(n4)
                let max = d3.max(n4)
                data = d3.filter(data, (d) => d['TN'] != '')

                x = d3.scaleTime()
                        .domain([min_date, max_date])
                        .range([wind.margin, wind.width - wind.margin])

                gx.transition()
                        .duration(500)
                        .attr("transform", `translate(${wind.margin}, ${wind.height - wind.margin})`)
                        .call(d3.axisBottom(x))

                y = d3.scaleLinear()
                    .domain([min, max])
                    .range([wind.height - wind.margin, wind.margin])

                gy.transition()
                        .duration(500)
                        .attr("transform", `translate(${wind.margin}, 0)`)
                        .call(d3.axisLeft(y))

            }

            // get selection for map
            d3.select("#map_select")
                .on('change', function(event, d){
                    // get option selected
                    selected = d3.select(this).property("value")
                    svg.selectAll('.events').remove() 
                    update_graph(cvs_files[selected].data)
                    data = cvs_files[selected].data
            })
        }


       var map = L.map('map').setView([ 41.024108551696095, -83.68860776599949], 17);

        let markers = []
        for(var i = 0; i < data.length; i++){
            let str_data = data[i].locName + "\n"  + data[i].notes
            markers.push(L.circle([data[i].y, data[i].x], {radius:3}).bindPopup(str_data))
        }
        let mark_group = L.layerGroup(markers)
        mark_group.addTo(map);

        // get selection for map
        d3.select("#map_select")
                .on('change', function(event, d){
                    // get option selected
                    selected = d3.select(this).property("value")
                    console.log(selected) 
                    data = cvs_files[selected].data 
                    data = d3.filter(data, (d) => d.x != '#N/A' && d.y != '#N/A')
                    map.removeLayer(mark_group)

                    markers = []
                    for(var i = 0; i < data.length; i++){
                        let str_data = data[i].locName + "\n"  + data[i].notes
                        markers.push(L.marker([data[i].y, data[i].x], {}).bindPopup(str_data))
                    }

                    mark_group = L.layerGroup(markers)
                    mark_group.addTo(map);
            })

            d3.select("#loc_select")
                .on('change', function(event, d){
                    // get option selected
                    selected = d3.select(this).property("value")
                    console.log(selected) 
                    let filt_data = d3.filter(data, d => d.locName == selected)
                    filt_data = d3.filter(filt_data, (d) => d.x != '#N/A' && d.y != '#N/A')
                    map.removeLayer(mark_group)

                    markers = []
                    for(var i = 0; i < filt_data.length; i++){
                        let str_data = filt_data[i].locName + "\n"  + data[i].notes
                        markers.push(L.marker([filt_data[i].y, filt_data[i].x], {}).bindPopup(str_data))
                    }

                    mark_group = L.layerGroup(markers)
                    mark_group.addTo(map);
            })

        

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 20,
            minZoom: 15,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            layers: [mark_group]
        }).addTo(map);

        
        graph.append(svg.node())

        

     </script>
</body>
</html>